<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>WCHAT - ìƒë‹´ì‚¬ ê´€ë¦¬ ì½˜ì†”</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
</head>
<body style="font-family: sans-serif; padding: 20px;">
    <h2>ğŸ§ ìƒë‹´ì‚¬ ì‹œìŠ¤í…œ</h2>
    <div id="loginArea">
        <input type="text" id="agentId" placeholder="ìƒë‹´ì‚¬ ì„±í•¨/ID ì…ë ¥">
        <button onclick="connect()">ìƒë‹´ì‚¬ ë¡œê·¸ì¸</button>
    </div>

    <div id="mainConsole" style="display:none; margin-top: 20px;">
        <div style="display: flex; gap: 30px;">
            <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                <h3 style="color: #e67e22;">ğŸ”” ì—°ê²° ìš”ì²­ (ëŒ€ê¸°ì—´)</h3>
                <ul id="requestList" style="list-style: none; padding: 0;"></ul>
            </div>

            <div style="flex: 2; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                <h3>ğŸ’¬ í™œì„± ì±„íŒ…: <span id="activeCustomer" style="color: #2980b9;">ì—†ìŒ</span></h3>
                <div id="chatArea" style="height: 350px; overflow-y: scroll; background: #f4f7f6; padding: 10px; margin-bottom: 10px; border: 1px solid #eee;"></div>
                <input type="text" id="message" style="width: 70%; padding: 8px;" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode==13) sendMessage()">
                <button onclick="sendMessage()" style="padding: 8px 15px;">ì „ì†¡</button>
                <button onclick="backToBot()" style="padding: 8px 15px; background: #95a5a6; color: white; border: none;">ìƒë‹´ ì¢…ë£Œ(ë´‡ ì „í™˜)</button>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentCustId = null;
        let agentName = "";

        function connect() {
            agentName = document.getElementById('agentId').value;
            if(!agentName) return alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            const socket = new SockJS('/ws-chat');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                document.getElementById('loginArea').style.display = 'none';
                document.getElementById('mainConsole').style.display = 'block';

                // [ì¤‘ìš”] ëª¨ë“  ìƒë‹´ì‚¬ê°€ ë“£ëŠ” ì•Œë¦¼ ì±„ë„ êµ¬ë…
                stompClient.subscribe('/sub/chat/agents', function (payload) {
                    const msg = JSON.parse(payload.body);
                    console.log("ì•Œë¦¼ ìˆ˜ì‹ :", msg);
                    if(msg.type === 'CALL_AGENT') {
                        addRequestToList(msg.sender);
                    }
                });

                // ê´€ë¦¬ì ê³µì§€ ì±„ë„ êµ¬ë…
                stompClient.subscribe('/sub/chat/room/ALL', function (payload) {
                    showChat(JSON.parse(payload.body));
                });

            }, function(err) { alert("ì—°ê²° ì‹¤íŒ¨: " + err); });
        }

        function addRequestToList(custId) {
            const list = document.getElementById('requestList');
            // ì´ë¯¸ ëª©ë¡ì— ìˆìœ¼ë©´ ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
            if (document.getElementById('btn-' + custId)) return;

            const li = document.createElement('li');
            li.id = 'li-' + custId;
            li.style.cssText = "padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;";
            li.innerHTML = `
                <span><strong>${custId}</strong> ê³ ê°ë‹˜</span>
                <button id="btn-${custId}" onclick="acceptChat('${custId}')" style="background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">ì—°ê²° ìˆ˜ë½</button>
            `;
            list.appendChild(li);
        }

        function acceptChat(custId) {
            currentCustId = custId;
            document.getElementById('activeCustomer').innerText = custId;
            
            // í•´ë‹¹ ê³ ê° ì „ìš© ì±„ë„ êµ¬ë… (ì´ì „ ëŒ€í™” ë° ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹ ìš©)
            stompClient.subscribe('/sub/chat/room/' + custId, function (payload) {
                showChat(JSON.parse(payload.body));
            });

            // ê³ ê°ì—ê²Œ ìˆ˜ë½ ë©”ì‹œì§€ ì „ì†¡
            const acceptMsg = {
                type: 'ACCEPT',
                roomId: custId,
                sender: 'ìƒë‹´ì‚¬(' + agentName + ')',
                message: "ì•ˆë…•í•˜ì„¸ìš”. ìƒë‹´ì‚¬ " + agentName + "ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?",
                isBotMode: false
            };
            stompClient.send("/pub/chat/message", {}, JSON.stringify(acceptMsg));

            // ëŒ€ê¸°ì—´ ì•„ì´í…œ ì œê±°
            const item = document.getElementById('li-' + custId);
            if(item) item.remove();
        }

        function sendMessage() {
            const input = document.getElementById('message');
            if(!currentCustId || !input.value) return;

            stompClient.send("/pub/chat/message", {}, JSON.stringify({
                type: 'TALK',
                roomId: currentCustId,
                sender: 'ìƒë‹´ì‚¬',
                message: input.value,
                isBotMode: false
            }));
            input.value = '';
        }

        function backToBot() {
            if(!currentCustId) return;
            stompClient.send("/pub/chat/message", {}, JSON.stringify({
                type: 'TO_BOT',
                roomId: currentCustId,
                sender: 'ì‹œìŠ¤í…œ',
                message: "ìƒë‹´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë´‡ì´ ì‘ëŒ€í•´ ë“œë¦½ë‹ˆë‹¤.",
                isBotMode: true
            }));
            currentCustId = null;
            document.getElementById('activeCustomer').innerText = "ì—†ìŒ";
            document.getElementById('chatArea').innerHTML = "";
        }

        function showChat(message) {
            const chatArea = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.style.marginBottom = "10px";
            div.innerHTML = `<span style="font-weight:bold; color:#2c3e50;">${message.sender}:</span> <span>${message.message}</span>`;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
    </script>
</body>
</html>